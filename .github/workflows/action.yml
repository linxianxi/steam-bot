name: Puppeteer Steam Scraper

# é€šè¿‡ API æ‰‹åŠ¨è§¦å‘ï¼ˆå¤–éƒ¨ cron ç­‰è°ƒåº¦å™¨ï¼‰
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    environment: production

    steps:
      # æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v5

      # å®‰è£… Node.js 20 å¹¶å¯ç”¨ Yarn ç¼“å­˜
      - name: Setup Node.js 20 with Yarn cache
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          # å¦‚æœä½ çš„ yarn.lock ä¸åœ¨æ ¹ç›®å½•ï¼Œéœ€è¦æŒ‡å®š cache-dependency-path
          cache-dependency-path: "yarn.lock"

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: yarn install --immutable

      - name: Run Puppeteer script
        run: yarn start
        env:
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
          PUSH_PHONE_URL: ${{ secrets.PUSH_PHONE_URL }}
          PHONE: ${{ secrets.PHONE }}
          AI_TOKEN: ${{ secrets.AI_TOKEN }}
          TRANSLATOR_PROMPT: ${{ secrets.TRANSLATOR_PROMPT }}

      - name: Commit sent.json if changed
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "Update sent.json with latest sent links"

      # è¿è¡Œå®Œæˆ
      - name: Done
        run: echo "ğŸš€ Puppeteer scraping finished"
